"use strict";function saveToStorage(a,b){localStorage.setItem(a,JSON.stringify(b))}function getFromStorage(a){return JSON.parse(localStorage.getItem(a))}angular.module("PvP",["ngCookies","ngResource","ngSanitize","ngRoute","ui.bootstrap","firebase","facebook","wu.masonry"]).config(["FacebookProvider",function(a){a.init("1440880659476523")}]).run(["$rootScope","$location","UserSession",function(a,b,c){a.$on("$locationChangeStart",function(a,d){!c.signedIn()&&d.indexOf("login")<0&&(a.preventDefault(),c.signIn().then(function(){b.path(d)},function(){b.path("/login")}))})}]).run(["$rootScope",function(a){a.safeApply=function(a){var b=this.$root.$$phase;"$apply"==b||"$digest"==b?a&&"function"==typeof a&&a():this.$apply(a)}}]).value("firebaseUrl","https://pvp.firebaseio.com/").config(["$routeProvider","$locationProvider",function(a){a.when("/",{templateUrl:"/views/main.html",controller:"MainCtrl"}).when("/login",{templateUrl:"/views/login.html",controller:"LoginCtrl"}).when("/lobby",{templateUrl:"/views/lobby.html",controller:"LobbyCtrl"}).when("/game/:gameId",{templateUrl:"/views/game.html",controller:"GameCtrl",resolve:{currentUser:function(a){return a.signIn().then(function(){return a.currentUser()})},game:function(a,b,c){return b.get(a.current.params.gameId).then(function(a){return a.$redeem(c.currentUser())})},rematchRequests:function(a){return a("/rematchRequests").$promise}}}).otherwise({redirectTo:"/"})}]),angular.module("PvP").controller("MainCtrl",["$scope","$location","$filter","Games","Rematch","UserSession",function(a,b,c,d,e,f){a.games=d.all(),e.listenAll(),a.add=function(){f.signIn().then(function(a){d.create({host:a.uid,title:"test",description:"Best game ever"}).then(function(a){console.log("created game with id",a.raw().$id),b.path("/game/"+a.raw().$id)},function(a){alert(a)})})},a.openGame=function(a){f.signIn().then(function(){b.path("/game/"+a)})}}]),angular.module("PvP").controller("LoginCtrl",["$scope","$rootScope","$location","UserSession",function(a,b,c,d){a.loggedIn=!1,a.openLogin=function(){d.signIn().then(a.greetUser)},a.greetUser=function(b){a.user=b,a.loggedIn=!0,a.greeting="Hi "+a.user.displayName,a.userName=a.user.link,a.profilePic="http://graph.facebook.com/"+a.user.link.split("https://www.facebook.com/")[1].trim()+"/picture"},a.loadGame=function(){console.log(c.path("lobby"))}}]),angular.module("PvP").controller("LobbyCtrl",["$scope","$location","Games","UserSession",function(a,b,c){a.games=c.all(),a.openGame=function(a){c.join(a).then(function(){b.path("/game/"+a)},function(a){alert(a)})}}]),angular.module("PvP").controller("GameCtrl",["$scope","$rootScope","$timeout","$location","$routeParams","$modal","currentUser","Games","GameStates","game","Moves","Rematch","rematchRequests","Facebook","pvpSync",function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o){function p(b){a.safeApply(function(){switch(b){case i.opened:console.log("Just opened the game, need to invite people: to invitePlayers"),a.viewUrl="views/game/invitePlayers.html",q();break;case i.invitesSent:console.log("Just sent all invitations, waiting to others to redeem: to preGame"),a.viewUrl="views/game/preGame.html";break;case i.started:console.log("All players have redeemed, start picking moves: to selectMoves"),a.viewUrl="views/game/selectMoves.html",s();break;case i.movesPicked:console.log("All players have selected moves, fight: to fightScene"),a.viewUrl="views/game/fightScene.html",y();break;case i.finished:a.viewUrl||(console.log("Someone died: to endGame"),a.viewUrl="views/game/endGame.html",z())}})}function q(){n.api("/me/friends","get",{fields:"id, name, picture",access_token:g.accessToken},function(b){a.friends=b.data})}function r(a){function b(){var b=!0;return _.keys(a).forEach(function(c){a[c].movesCommitted||(b=!1)}),b}j.raw().state==i.started&&b()&&(j.raw().state=i.movesPicked,j.$save())}function s(){console.log("setupSelectMoves"),j.player(g.uid).selectedMoves=j.player(g.uid).selectedMoves||{},j.player(g.uid).movesCommitted=j.player(g.uid).movesCommitted||!1,a.moves=k.moves,a.selectedMoves=angular.copy(j.player(g.uid).selectedMoves),a.movesCommitted=angular.copy(j.player(g.uid).movesCommitted),a.selectedMovesCount=function(){return _.keys(a.selectedMoves).length},a.isSelected=function(b){return a.selectedMoves&&_.has(a.selectedMoves,b)},a.selectMove=function(b){a.selectedMovesCount()<3&&(a.selectedMoves[b]=angular.copy(a.moves[b]))},a.unselectMove=function(b){delete a.selectedMoves[b]},a.commitSelectedMoves=function(){3==a.selectedMovesCount()&&(a.movesCommitted=j.player(g.uid).movesCommitted=!0,j.player(g.uid).selectedMoves=a.selectedMoves,j.$save())}}function t(a,b,c,d){(0>=a||0>=b)&&(a>0?j.raw().winner=g.uid:b>0?j.raw().winner=j.opponentOf(g.uid).uid:Math.abs(c)>Math.abs(d)?j.raw().winner=j.opponentOf(g.uid).uid:Math.abs(c)<Math.abs(d)&&(j.raw().winner=g.uid))}function u(b){function c(){return _.keys(b).length==_.keys(j.raw().participants).length}if(console.log("currentRound onChange"),j.raw().state==i.movesPicked){if(c()){console.log("all committed"),a.notSeenAnimation=!0;var d=j.opponentOf(g.uid).uid;a.opponentAttack=k.moves[j.raw().currentRound[d].moveKey],a.opponentSmackTalk=j.raw().currentRound[d].smackTalk;var e=k.damageMatrix(k.moves[b[g.uid].moveKey].name,k.moves[b[j.opponentOf(g.uid).uid].moveKey].name);b[g.uid].doneDamage=e[1],b[j.opponentOf(g.uid).uid].doneDamage=e[0],e[0]>0&&(j.player(g.uid).health-=e[0]),e[1]>0&&(j.opponentOf(g.uid).health-=e[1]),console.log("move damage results",e),b.log=k.textualizeAttack(j.player(g.uid).name,j.opponentOf(g.uid).name,k.moves[b[g.uid].moveKey].name,k.moves[b[j.opponentOf(g.uid).uid].moveKey].name,e[0],e[1]),t(j.player(g.uid).health,j.opponentOf(g.uid).health,e[0],e[1]),j.raw().rounds.push(angular.copy(b)),j.raw().currentRound={},j.$save(),$("#heart").removeClass("hinge animated"),$("#heart2").removeClass("hinge animated"),$("#heart").html(e[0]>0?"-"+e[0]+" &hearts;":""),$("#heart2").html(e[1]>0?"-"+e[1]+" &hearts;":""),$("#heart").addClass("hinge animated"),$("#heart2").addClass("hinge animated")}x()}}function v(b){c(function(){a.rounds=angular.copy(b),console.log("rounds",a.rounds)})}function w(){j.raw().state>=i.movesPicked&&(a.health=j.player(g.uid).health,a.opponentHealth=j.opponentOf(g.uid).health,console.log("update health",a.health,a.opponentHealth))}function x(){a.dialog=a.attackCommitted()&&!a.notSeenAnimation?"Waiting on your opponent...":"What should "+j.player(g.uid).name+" do?"}function y(){console.count("setupFightScene"),j.raw().rounds=j.raw().rounds||[],j.raw().currentRound=j.raw().currentRound||{},a.notSeenAnimation=!1,a.form={},a.opponentSmackTalk="",a.attack=a.opponentAttack=null,j.raw().currentRound[g.uid]&&(a.form.smackTalk=j.raw().currentRound[g.uid].smackTalk,a.attack=k.moves[j.raw().currentRound[g.uid].moveKey]),a.attackCommitted=function(){return j.raw().currentRound&&_.has(j.raw().currentRound,g.uid)||a.notSeenAnimation},a.replayAnimation=function(){},a.skipAnimation=function(){a.notSeenAnimation=!1},x(),a.selectedMoves=j.player(g.uid).selectedMoves,a.health=j.player(g.uid).health,a.opponentHealth=j.opponentOf(g.uid).health,a.fight=function(b,c){j.raw().currentRound=j.raw().currentRound||{},j.raw().currentRound[g.uid]={moveKey:b,smackTalk:c},j.$save(),a.form.smackTalk=angular.copy(c),a.attack=angular.copy(k.moves[b]),console.log("attacking with attack and smackTalk",a.attack,a.form.smackTalk)},a.dice=function(){}}function z(){l.listen(j),a.winner=j.player(j.raw().winner),a.rematch=function(){var a={from:g.uid,to:j.opponentOf(g.uid).uid,fromGameId:e.gameId},b=!1;m.$getIndex().forEach(function(c){_.isEqual(m[c],a)&&(b=!0)}),b||m.$push(a)},a.toLobby=function(){d.path("/")}}b.$on("$routeChangeError",function(){d.path("/")}),j.raw().$onChange("state",p),p(j.raw().state),j.raw().$onChange("participants",r),r(j.raw().participants),a.inviteNoop=function(){j.raw().state=i.invitesSent,j.$save()},a.$watch("notSeenAnimation",function(b,c){if(!b&&c&&(console.log("Reset smackTalk, and opponent"),a.form={},a.opponentSmackTalk="",a.attack=a.opponentAttack=null,j.raw().winner)){j.raw().state=i.finished,j.$save(),console.log("Someone died: to endGame"),a.viewUrl="views/game/endGame.html",z();var d=o("/players/"+j.raw().winner);d.$promise.then(function(){d.wins=d.wins||[],d.wins.indexOf(j.raw().$id)&&(d.wins.push(j.raw().$id),d.$save())});var e=o("/players/"+j.opponentOf(j.raw().winner).uid);e.$promise.then(function(){e.loses=e.loses||[],e.loses.indexOf(j.raw().$id)&&(e.loses.push(j.raw().$id),e.$save())})}}),j.raw().$onChange("currentRound",u),u(j.raw().currentRound),j.raw().$onChange("rounds",v),v(j.raw().rounds),j.raw().$onChange("participants",w),w(j.raw().participants)}]),angular.module("PvP").directive("tooltip",function(){return{restrict:"AE",scope:{tooltip:"@"},link:function(){}}}),angular.module("PvP").filter("calendar",function(){return function(a){return a?moment(a).format("MMMM Do YYYY, h:mm:ss a"):""}}).filter("emptyOrInvited",["GameStates","UserSession","Game",function(a,b,c){return function(d){function e(d){var e=new c,f=d.state>=a.invitesSent&&Array.isArray(d.invitations)&&-1!=d.invitations.indexOf(b.currentUser().uid),g=d.state>=a.invitesSent&&_.keys(d.participants).length<e._limit&&!_.has(d,"invitations"),h=d.state>=a.movesPicked&&d.participants[b.currentUser().uid],i=d.host&&d.host==b.currentUser().uid;return g||f||h||i}var f={};return d.$getIndex().forEach(function(a){e(d[a])&&(f[a]=d[a])}),f}}]),angular.module("PvP").factory("pvpSync",["firebaseUrl","$interval","$timeout","$q",function(a,b,c,d){function e(a){return"object"==typeof a&&null!=a?(_.keys(a).forEach(function(b){"undefined"==typeof a[b]||null==a[b]?(console.log("undefined property",b,a[b]),a[b]={}):a[b]=e(a[b])}),a):null==a?{}:a}function f(a){console.log("_clean");var b=_.omit(a,Object.keys(a).filter(function(a){return a.startsWith("$")}));return e(b)}var g=function(e){function h(a,b){m[a]&&(console.log("trigger callbacks for",a),m[a].forEach(function(a){a(b)}))}function i(a,b){c(function(){-1!=k.$index.indexOf(a.name())&&k.$index.splice(k.$index.indexOf(a.name()),1),null==a.val()?delete k[a.name()]:(k[a.name()]=a.val(),-1!=k.$index.indexOf(b)?k.$index.splice(k.$index.indexOf(b)+1,0,a.name()):k.$index.splice(0,0,a.name()),h(a.name(),a.val()))})}var j,k={},l=d.defer(),m={},n={};return"string"==typeof e?j=new Firebase(a+e):e instanceof Firebase&&(j=e),k=_.extend(k,{$id:j.ref().name(),$ref:j,$child:function(a){return g(j.child(a))},$set:function(a){var b=d.defer();return j.set(f(a),function(){b.resolve(this)}.bind(this)),b.promise},$push:function(a){var b=d.defer(),c=j.push(f(a),function(){g(c).$promise.then(function(a){b.resolve(a)})});return b.promise},$save:function(){var a=d.defer();return j.set(f(this),function(){a.resolve(this)}.bind(this)),a.promise},$index:[],$getIndex:function(){return this.$index},$promise:l.promise,$onChange:function(a,b){""==a||"undefined"==typeof a?(m.$$itself=m.$$itself||[],m.$$itself.push(b)):(m[a]=m[a]||[],m[a].push(b))},$onPoll:function(a,b){n[a]=n[a]||[],n[a].push(b)}}),b(function(){_.keys(n).forEach(function(a){n[a].forEach(function(b){b(k[a])})})},1e3),j.on("child_added",i),j.on("child_changed",i),j.on("child_moved",i),j.on("child_removed",function(a){c(function(){-1!=k.$index.indexOf(a.name())&&k.$index.splice(k.$index.indexOf(a.name()),1),delete k[a.name()]})}),j.on("value",function(a){c(function(){k=_.extend(k,a.val()),l.resolve(k),h("$$itself",k)})}),k};return g}]),angular.module("PvP").service("UserSession",["FacebookBase","$timeout","$q","pvpSync",function(a,b,c,d){function e(a){g[a.uid]?(g[a.uid].profile=a,g.$save()):g.$child(a.uid).$child("profile").$set(a)}var f,g=d("/players"),h=function(a){return e(a),f.resolve(a),a},i=function(){f.reject()},j=function(a){return saveToStorage("user",a),h(a),a},k=function(){getFromStorage("user")?h(getFromStorage("user")):a.openLogin().then(j,i)},l=function(){return f=c.defer(),b(k,10),f.promise};return{signIn:l,signedIn:function(){return!!getFromStorage("user")},currentUser:function(){return getFromStorage("user")},completeSignIn:j,_resolveOrPrompt:k,_completeAuth:h}}]),angular.module("PvP").service("FacebookBase",["$rootScope","$q","Facebook",function(a,b){return{openLogin:function(){console.log("openLogin");var c=b.defer(),d=new Firebase("https://pvp.firebaseio.com"),e=new FirebaseSimpleLogin(d,function(b,d){console.log("FirebaseSimpleLogin",b,d),b?console.error(b):d&&(console.log("User ID: "+d.id+", Provider: "+d.provider),a.safeApply(function(){c.resolve(d)}))});return e.login("facebook",{rememberMe:!0,preferRedirect:!0,scope:"email,user_likes,basic_info,user_friends"}),c.promise}}}]),angular.module("PvP").factory("Moves",["firebaseUrl",function(){function a(a){var b=a.split(" ");return 3==b.length&&b.splice(1,1),b.map(function(a,c){return b.length-1==c?a[0]+".":a}).join(" ")}function b(b,c,d,e,f,g){return a(b)+" has taken "+f+" from "+e+" :: "+a(c)+" has taken "+g+" from "+d+"."}function c(a){var b=Math.floor(100*Math.random());if(60>=b)return a?[2,0]:[0,2];var b=Math.floor(40*Math.random());return 30>=b?[0,0]:a?[0,2]:[2,0]}function d(a,b){if(console.log("damageMatrix",a,b),"Fire"==a){if("Fire"==b)return[2,2];if("Water"==b)return[2,1];if("Lightning"==b)return[1,2];if("Shield"==b)return c()}else if("Water"==a){if("Fire"==b)return[1,2];if("Water"==b)return[1,1];if("Lightning"==b)return[2,1];if("Shield"==b)return c()}else if("Lightning"==a){if("Fire"==b)return[2,1];if("Water"==b)return[1,2];if("Lightning"==b){var d=Math.floor(2*Math.random());if(0==d){if(side=Math.floor(2*Math.random()),0==side)return[3,0];if(1==side)return[0,3]}else if(1==d)return[2,2]}else if("Shield"==b)return c()}else if("Shield"==a){if("Fire"==b)return c(!0);if("Water"==b)return c(!0);if("Lightning"==b)return c(!0);if("Shield"==b)return[0,0]}return[0,0]}var e={fire:{attackCss:"fire-attack",moveCss:"fire-move",name:"Fire",src:"images/buttons/volcanobutton.png"},lightning:{attackCss:"lightning-attack",moveCss:"lightning-move",name:"Lightning",src:"images/buttons/lightningbutton.png"},water:{attackCss:"water-attack",moveCss:"water-move",name:"Water",src:"images/buttons/waterbutton.png"},shield:{attackCss:"shield-attack",moveCss:"shield-move",name:"Shield",src:"images/buttons/magneticfieldbutton.png"}};return{moves:e,damageMatrix:d,textualizeAttack:b}}]),angular.module("PvP").factory("GameStates",function(){return{opened:0,invitesSent:1,started:2,movesPicked:3,finished:4}}).factory("Game",["$q","GameStates",function(a,b){var c=function(a){this._game=a,this._limit=2};return c.prototype.raw=function(){return this._game},c.prototype.opponentOf=function(a){for(var b in this._game.participants)if(this._game.participants.hasOwnProperty(b)&&b!=a)return this._game.participants[b]},c.prototype.player=function(a){return this._game.participants[a]},c.prototype.$redeem=function(c){var d=this;if(this._game.participants=this._game.participants||{},this._game.participants&&this._game.participants[c.uid])return d;if(!this._game.invitations&&this._game.state<b.started);else if(this._game.invitations&&-1==this._game.invitations.indexOf(c.uid)||this._game.state>=b.started)return a.reject("Not invited or Game started");return this._game.participants[c.uid]={selectedMoves:{},health:10,name:c.displayName,uid:c.uid},_.keys(this._game.participants).length==this._limit&&(this._game.state=b.started),this._game.$save().then(function(){return d})},c.prototype.$save=function(){return this._game.$save()},c.prototype.$invite=function(c){if(this._game.invitations=this._game.invitations||[],c.length+this._game.invitations.length>this._limit)return a.reject("Can't invite over the limit ("+this._limit+")");if(0==c.length)return a.reject("Has to invite users");var d=this;return c.forEach(function(a){console.log("inviting",a),-1==d._game.invitations.indexOf(a.uid)&&d._game.invitations.push(a.uid)}),this._game.state=b.invitesSent,this._game.$save().then(function(){return d})},c}]),angular.module("PvP").factory("Games",["$rootScope","$q","pvpSync","UserSession","Game",function(a,b,c,d,e){var f=c("/games");return{all:function(){return f},get:function(a){return f.$child(a).$promise.then(function(a){return new e(a)})},construct:function(a){return new e(a)},create:function(a){return a=_.extend(a,{createdAt:moment().toISOString(),rounds:[],state:0}),f.$push(a).then(function(a){return new e(a)})}}}]),angular.module("PvP").factory("Rematch",["$location","Game","Games","UserSession","GameStates","$modal","pvpSync",function(a,b,c,d,e,f,g){var h=null;return{listen:function(b){function i(g){var i=d.currentUser();b.raw().state>=e.finished&&g.$getIndex().forEach(function(d){var e=g[d];if(e.from==i.uid&&e.to==b.opponentOf(i.uid).uid&&e.response&&!e.gameId)if("accept"==e.response){var j=b.opponentOf(i.uid);c.create({host:i.uid,title:"A Rematch from "+i.name+" to "+j.name,description:"Best game ever"}).then(function(b){b.$invite([i,j]).then(function(){b.$redeem(i).then(function(){e.gameId=b.raw().$id,g.$save().then(function(){a.path("/game/"+b.raw().$id)})},function(a){alert(a)})},function(a){alert(a)})},function(a){alert(a)})}else"reject"==e.response&&(delete g[d],g.$save());else e.to!=i.uid||e.from!=b.opponentOf(i.uid).uid||_.has(e,"response")?e.to==i.uid&&e.from==b.opponentOf(i.uid).uid&&_.has(e,"response")&&"accept"==e.response&&_.has(e,"gameId")&&(delete g[d],g.$save().then(function(){c.get(e.gameId).then(function(b){b.$redeem(i).then(function(b){a.path("/game/"+b.raw().$id)},function(a){alert(a)})})})):(console.log("Received a rematch request!"),null==h&&(h=f.open({backdrop:"static",keyboard:!1,templateUrl:"views/game/modal/requestRematch.html",controller:function(a,c){a.requester=b.player(e.from),a.accept=function(){console.log("[MODAL] accepting request",e),e.response="accept",g.$save(),h=null,c.close()},a.reject=function(){console.log("[MODAL] rejecting request",e),e.response="reject",g.$save(),h=null,c.close()}}})))})}g("/rematchRequests").$promise.then(function(a){a.$onChange("",i),i(a)})},listenAll:function(){var a=this;c.all().$promise.then(function(c){c.$getIndex().forEach(function(d){a.listen(new b(c[d]))})})}}}]);