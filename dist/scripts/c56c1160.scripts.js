define(["angular","angular-sanitize","angular-route","angular-resource","angular-facebook","angular-cookies","angular-bootstrap","firebase","firebase-simple-login","controllers/index","services/index","directives","filters"],function(a){"use strict";return a.module("PvP",["ngCookies","ngResource","ngSanitize","ngRoute","ui.bootstrap","facebook","wu.masonry","PvP.controllers","PvP.services","PvP.directives","PvP.filters"]).config(["FacebookProvider",function(a){a.init("1440880659476523")}]).run(["$rootScope","$location","UserSession",function(a){a.$on("$locationChangeStart",function(){})}]).run(["$rootScope",function(a){a.safeApply=function(a){var b=this.$root.$$phase;"$apply"==b||"$digest"==b?a&&"function"==typeof a&&a():this.$apply(a)}}]).config(["$routeProvider","$locationProvider",function(a){a.when("/",{templateUrl:"/views/main.html",controller:"MainCtrl"}).when("/login",{templateUrl:"/views/login.html",controller:"LoginCtrl"}).when("/lobby",{templateUrl:"/views/lobby.html",controller:"LobbyCtrl"}).when("/game/:gameId",{templateUrl:"/views/game.html",controller:"GameCtrl",resolve:{game:function(a,b,c,d){return c.get(b.current.params.gameId).then(function(a){return d.signIn().then(function(){return a.$redeem(d.currentUser())})})},rematchRequests:function(a){return a("/rematchRequests").$promise}}}).otherwise({redirectTo:"/"})}])}),define(["angular","services/index"],function(a){"use strict";return a.module("PvP.controllers.main",[]).controller("MainCtrl",["$scope","$window","$location","$filter","Games","Rematch","UserSession",function(a,b,c,d,e,f,g){a.games=e.all(),f.listenAll(),a.add=function(){g.signIn().then(function(a){e.create({host:a.uid,title:"test",description:"Best game ever"}).then(function(a){b.location.href="/#/game/"+a.raw().$id},function(a){alert(a)})})},a.openGame=function(a){b.location.href="/#/game/"+a}}])}),define(["angular","services/index"],function(a){"use strict";return a.module("PvP.controllers.login",[]).controller("LoginCtrl",["$scope","$rootScope","$location","UserSession",function(a,b,c,d){a.loggedIn=!1,a.openLogin=function(){d.signIn().then(a.greetUser)},a.greetUser=function(b){a.user=b,a.loggedIn=!0,a.greeting="Hi "+a.user.displayName,a.userName=a.user.link,a.profilePic="http://graph.facebook.com/"+a.user.link.split("https://www.facebook.com/")[1].trim()+"/picture"},a.loadGame=function(){console.log(c.path("lobby"))}}])}),define(["angular","services/index"],function(a){"use strict";return a.module("PvP.controllers.lobby",[]).controller("LobbyCtrl",["$scope","$location","Games","UserSession",function(a,b,c){a.games=c.all(),a.openGame=function(a){c.join(a).then(function(){b.path("/game/"+a)},function(a){alert(a)})}}])}),define(["angular","require","jquery","masonry","angular-masonry","services/index"],function(a,b,c,d){"use strict";return b(["jquery-bridget/jquery.bridget"],function(){c.bridget("masonry",d)}),a.module("PvP.controllers.game",["PvP.services","PvP.directives"]).controller("GameCtrl",["$scope","$rootScope","$timeout","$location","$routeParams","$modal","Games","GameStates","game","Moves","Rematch","rematchRequests","pvpSync","UserSession","Facebook",function(b,d,e,f,g,h,i,j,k,l,m,n,o,p,q){function r(a){b.safeApply(function(){switch(a){case j.opened:console.log("Just opened the game, need to invite people: to invitePlayers"),b.viewUrl="views/game/invitePlayers.html",s();break;case j.invitesSent:console.log("Just sent all invitations, waiting to others to redeem: to preGame"),b.viewUrl="views/game/preGame.html";break;case j.started:console.log("All players have redeemed, start picking moves: to selectMoves"),b.viewUrl="views/game/selectMoves.html",u();break;case j.movesPicked:console.log("All players have selected moves, fight: to fightScene"),b.viewUrl="famous"==f.search().mode?"views/game/fightSceneFamous.html":"views/game/fightScene.html",A();break;case j.finished:b.viewUrl||(console.log("Someone died: to endGame"),b.viewUrl="views/game/endGame.html",B())}})}function s(){q.api("/me/friends","get",{fields:"id, name, picture",access_token:C.accessToken},function(a){b.friends=a.data})}function t(a){function b(){var b=!0;return _.keys(a).forEach(function(c){a[c].movesCommitted||(b=!1)}),b}k.raw().state==j.started&&b()&&(k.raw().state=j.movesPicked,k.$save())}function u(){console.log("setupSelectMoves"),k.player(C.uid).selectedMoves=k.player(C.uid).selectedMoves||{},k.player(C.uid).movesCommitted=k.player(C.uid).movesCommitted||!1,b.moves=l.moves,b.selectedMoves=a.copy(k.player(C.uid).selectedMoves),b.movesCommitted=a.copy(k.player(C.uid).movesCommitted),b.selectedMovesCount=function(){return _.keys(b.selectedMoves).length},b.isSelected=function(a){return b.selectedMoves&&_.has(b.selectedMoves,a)},b.selectMove=function(c){b.selectedMovesCount()<3&&(b.selectedMoves[c]=a.copy(b.moves[c]))},b.unselectMove=function(a){delete b.selectedMoves[a]},b.commitSelectedMoves=function(){3==b.selectedMovesCount()&&(b.movesCommitted=k.player(C.uid).movesCommitted=!0,k.player(C.uid).selectedMoves=b.selectedMoves,k.$save())}}function v(a,b,c,d){(0>=a||0>=b)&&(a>0?k.raw().winner=C.uid:b>0?k.raw().winner=k.opponentOf(C.uid).uid:Math.abs(c)>Math.abs(d)?k.raw().winner=k.opponentOf(C.uid).uid:Math.abs(c)<Math.abs(d)&&(k.raw().winner=C.uid))}function w(d){function e(){return _.keys(d).length==_.keys(k.raw().participants).length}if(console.log("currentRound onChange"),k.raw().state==j.movesPicked){if(k.raw().winner&&(b.notSeenAnimation=!0),e()){console.log("all committed"),b.notSeenAnimation=!0;var f=k.opponentOf(C.uid).uid;b.opponentAttack=l.moves[k.raw().currentRound[f].moveKey],b.opponentSmackTalk=k.raw().currentRound[f].smackTalk;var g=l.damageMatrix(l.moves[d[C.uid].moveKey].name,l.moves[d[k.opponentOf(C.uid).uid].moveKey].name);d[C.uid].doneDamage=g[1],d[k.opponentOf(C.uid).uid].doneDamage=g[0],g[0]>0&&(k.player(C.uid).health-=g[0]),g[1]>0&&(k.opponentOf(C.uid).health-=g[1]),console.log("move damage results",g),d.log=l.textualizeAttack(k.player(C.uid).name,k.opponentOf(C.uid).name,l.moves[d[C.uid].moveKey].name,l.moves[d[k.opponentOf(C.uid).uid].moveKey].name,g[0],g[1]),v(k.player(C.uid).health,k.opponentOf(C.uid).health,g[0],g[1]),k.raw().rounds.push(a.copy(d)),k.raw().currentRound={},k.$save(),c("#heart").removeClass("hinge animated"),c("#heart2").removeClass("hinge animated"),c("#heart").html(g[0]>0?"-"+g[0]+" &hearts;":""),c("#heart2").html(g[1]>0?"-"+g[1]+" &hearts;":""),c("#heart").addClass("hinge animated"),c("#heart2").addClass("hinge animated")}z()}}function x(c){e(function(){b.rounds=a.copy(c),console.log("rounds",b.rounds)})}function y(){k.raw().state>=j.movesPicked&&(b.health=k.player(C.uid).health,b.opponentHealth=k.opponentOf(C.uid).health,console.log("update health",b.health,b.opponentHealth))}function z(){b.dialog=b.attackCommitted()&&!b.notSeenAnimation?"Waiting on your opponent...":"What should "+k.player(C.uid).name+" do?"}function A(){console.count("setupFightScene"),k.raw().rounds=k.raw().rounds||[],k.raw().currentRound=k.raw().currentRound||{},b.notSeenAnimation=!1,b.form={},b.opponentSmackTalk="",b.attack=b.opponentAttack=null,k.raw().currentRound[C.uid]&&(b.form.smackTalk=k.raw().currentRound[C.uid].smackTalk,b.attack=l.moves[k.raw().currentRound[C.uid].moveKey]),b.attackCommitted=function(){return k.raw().currentRound&&_.has(k.raw().currentRound,C.uid)||b.notSeenAnimation},b.replayAnimation=function(){},b.skipAnimation=function(){b.notSeenAnimation=!1},z(),b.selectedMoves=k.player(C.uid).selectedMoves,b.health=k.player(C.uid).health,b.opponentHealth=k.opponentOf(C.uid).health,b.fight=function(c,d){k.raw().currentRound=k.raw().currentRound||{},k.raw().currentRound[C.uid]={moveKey:c,smackTalk:d},k.$save(),b.form.smackTalk=a.copy(d),b.attack=a.copy(l.moves[c]),console.log("attacking with attack and smackTalk",b.attack,b.form.smackTalk)},b.dice=function(){}}function B(){m.listen(k),b.winner=k.player(k.raw().winner),b.rematch=function(){var a={from:C.uid,to:k.opponentOf(C.uid).uid,fromGameId:g.gameId},b=!1;n.$getIndex().forEach(function(c){_.isEqual(n[c],a)&&(b=!0)}),b||n.$push(a)},b.toLobby=function(){f.path("/")}}var C=p.currentUser();d.$on("$routeChangeError",function(){f.path("/")}),k.raw().$onChange("state",r),r(k.raw().state),k.raw().$onChange("participants",t),t(k.raw().participants),b.inviteNoop=function(){k.raw().state=j.invitesSent,k.$save()},b.$watch("notSeenAnimation",function(a,c){if(!a&&c&&(console.log("Reset smackTalk, and opponent"),b.form={},b.opponentSmackTalk="",b.attack=b.opponentAttack=null,k.raw().winner)){k.raw().state=j.finished,k.$save(),console.log("Someone died: to endGame"),b.viewUrl="views/game/endGame.html",B();var d=o("/players/"+k.raw().winner);d.$promise.then(function(){d.wins=d.wins||[],d.wins.indexOf(k.raw().$id)&&(d.wins.push(k.raw().$id),d.$save())});var e=o("/players/"+k.opponentOf(k.raw().winner).uid);e.$promise.then(function(){e.loses=e.loses||[],e.loses.indexOf(k.raw().$id)&&(e.loses.push(k.raw().$id),e.$save())})}}),k.raw().$onChange("currentRound",w),w(k.raw().currentRound),k.raw().$onChange("rounds",x),x(k.raw().rounds),k.raw().$onChange("participants",y),y(k.raw().participants)}])}),define(function(a){"user strict";var b=a("angular");return b.module("PvP.directives",[]).directive("arena",["$timeout",function(b){return{restrict:"AE",link:function(c,d){b(function(){function b(a){var b,d;a?(b={bubbleSurfaceClasses:["bubble2-famous"],heartIndex:0,chainOfHeartsOutputFunction:function(a,b,c){var d=r.translate(175,175,0);return d=r.multiply(r.aboutOrigin([200,0,200],r.rotateY(360*c/10*Math.PI/180+this.heartIndex)),d),d=r.multiply(r.rotateX(20*Math.PI/180),d),d=r.multiply(r.rotateZ(20*Math.PI/180),d),{transform:d,target:a.render()}},planetRotateAngle:0,planetRotateDirection:1,bubbleNodeModifierTransform:r.translate(50,300,0)},d=w.add(new i({origin:[.8,.2]}))):(b={bubbleSurfaceClasses:["bubble-famous"],heartIndex:0,chainOfHeartsOutputFunction:function(a,b,c){var d=r.translate(175,175,0);return d=r.multiply(r.aboutOrigin([200,0,200],r.rotateY(360*c/10*Math.PI/180+this.heartIndex)),d),d=r.multiply(r.rotateX(20*Math.PI/180),d),d=r.multiply(r.rotateZ(20*Math.PI/180),d),{transform:d,target:a.render()}},planetRotateAngle:0,planetRotateDirection:1,bubbleNodeModifierTransform:r.translate(-50,-300,0)},d=w.add(new h({origin:[.2,.8]})));var n=function(){function d(){function d(){function d(){e.render(),b.heartIndex+=.01}var e=new k,h=[];e.setOutputFunction(b.chainOfHeartsOutputFunction.bind(b)),e.sequenceFrom(h);var j=function(b,c){b!=c&&(0==b?e.sequenceFrom([new f]):(h.length=0,_.range(b).forEach(function(){var a=new g({size:[50,50],content:"images/misc/life.png"});h.push(a)})),e.render());var d=a?"blue":"pink";10==b?m.setContent("images/planets/"+d+"-state1.png"):10>b&&b>=5?m.setContent("images/planets/"+d+"-state2.png"):5>b&&m.setContent("images/planets/"+d+"-state3.png")};return i(m,[d]),a?(j(c.opponentHealth),c.$watch("opponentHealth",j)):(j(c.health),c.$watch("health",j)),e}function i(a,b){a.on("mouseover",function(){b.forEach(function(a){e.on("prerender",a)})}),a.on("mouseout",function(){b.forEach(function(a){s.clear(a)}),n.setTransform(r.rotateZ(0))})}function j(){n.setTransform(r.rotateZ(b.planetRotateAngle)),b.planetRotateDirection?b.planetRotateAngle+=1*Math.PI/180:b.planetRotateAngle-=1*Math.PI/180,b.planetRotateAngle>=Math.PI/180?b.planetRotateDirection=0:b.planetRotateAngle<=-Math.PI/180&&(b.planetRotateDirection=1)}var l=new q,m=new g({size:[300,300]}),n=new h({origin:[.5,.5]});return i(m,[j]),l.add(d()),l.add(n).add(m),l}var i=new q,j=new q;return j.add(d()),i.add(new h({size:[300,300]})).add(j),i},t=function(){function d(){var a=[];y.sequenceFrom(a),_.keys(c.selectedMoves).forEach(function(b){var d=c.selectedMoves[b],e=new f({size:[60,60],classes:[d.attackCss],properties:{tooltip:d.name}}),g=new o({position:[0,0,0]}),h=new p({anchor:[0,0,0],period:400,dampingRatio:.2});x.attach(h,g),x.addBody(g),e.on("click",function(){g.applyForce(new l(0,0,-0.05)),c.fight(b,c.form.smackTalk)});var i=new q;i.add(g).add(e),a.push(i)})}var e=new q,g=new f({classes:b.bubbleSurfaceClasses,properties:{lineHeight:"100px",textAlign:"center",fontSize:"22px",color:"#ACD6E5"}}),i=new h({size:[350,150],transform:b.bubbleNodeModifierTransform}),n=new f({size:[60,60]}),r=new v,s=new q,t=new q;if(t.add(new h({origin:[.5,.8]})).add(n),a)r.show(t),c.$watch("opponentAttack",function(a){console.log("opponentAttack",a),a?(n.setClasses([a.attackCss]),n.setProperties({tooltip:a.name})):(n.setClasses([]),n.setProperties({tooltip:""}))}),c.$watch("opponentSmackTalk",function(a){g.setContent(a?a:c.notSeenAnimation?"":"...")});else{var u=new q,w=new j({size:[void 0,40],name:"smackTalkSurface",placeholder:"Smack Talk",value:"",type:"text"});w.on("keyup",function(){c.safeApply(function(){c.$parent.form.smackTalk=w.getValue()})});var y=new k({direction:m.Direction.X,size:[200,60]});d(),c.$watch("attack",function(a){a?(n.setClasses([a.attackCss]),n.setProperties({tooltip:a.name})):(n.setClasses([]),n.setProperties({tooltip:""}))}),c.$watch("attackCommitted()",function(a){console.log("attackCommitted",a),a?(g.setContent(c.form.smackTalk||""),r.show(t)):(g.setContent(""),r.show(u))}),u.add(new h({origin:[.5,.8]})).add(y),u.add(new h({origin:[.5,.1]})).add(w)}return s.add(new h({origin:[.5,.5]})).add(g),s.add(new h({origin:[.5,.5]})).add(r),e.add(i).add(s),e};return d.add(n()),d.add(t()),d}var e=a("famous/core/Engine"),f=a("famous/core/Surface"),g=a("famous/surfaces/ImageSurface"),h=a("famous/modifiers/StateModifier"),i=(a("famous/modifiers/Draggable"),a("famous/transitions/Easing"),a("famous/core/Modifier")),j=a("famous/surfaces/InputSurface"),k=a("famous/views/SequentialLayout"),l=a("famous/math/Vector"),m=a("famous/utilities/Utility"),n=a("famous/physics/PhysicsEngine"),o=a("famous/physics/bodies/Particle"),p=a("famous/physics/forces/Spring"),q=a("famous/core/RenderNode"),r=a("famous/core/Transform"),s=(a("famous/transitions/Transitionable"),a("famous/utilities/Timer")),k=(a("famous/views/GridLayout"),a("famous/views/SequentialLayout")),t=a("famous/views/Scrollview"),u=a("famous/surfaces/ContainerSurface"),v=a("famous/views/RenderController"),w=e.createContext(d[0]),x=new n,y=new h({origin:[.5,0]}),z=new f({size:[void 0,100],classes:["red-bg"],content:"What should we do?",properties:{lineHeight:"100px",textAlign:"center",fontSize:"xx-large"}}),A=new h({transform:r.inFront,origin:[.5,1]}),B=new v,C=new u({size:[void 0,200],properties:{overflow:"hidden"},classes:["console-log-famous"]}),D=(new f({size:[void 0,100]}),new f({size:[void 0,100],properties:{lineHeight:"100px",textAlign:"center"},content:"CLICK ME TO TOGGLE AWESOMESAUCE"}));B.show(D);var E=new t,F=[];E.sequenceFrom(F),C.add(E),D.on("click",function(){B.show(C)}),C.on("click",function(){B.show(D)});var G=new h({origin:[.5,.5]}),H=new f({size:[500,500],classes:["explosion"]}),I=new v,J=new q,K=new f,L=new h({origin:[0,0]}),M=new f({size:[void 0,void 0],classes:["overlay"]}),N=new h({origin:[.5,.5]}),O=new f({size:[170,120],classes:["start-animation-btn-famous"]});O.on("click",function(){});var P=new h({transform:r.translate(0,70,2)}),Q=new f({size:[170,!0],content:"Skip animation",properties:{lineHeight:"25px",textAlign:"center",color:"white",cursor:"pointer"}});Q.on("click",function(){c.safeApply(function(){c.$parent.notSeenAnimation=!1})}),J.add(L).add(M);var R=J.add(N);R.add(O),R.add(P).add(Q),c.$watch("notSeenAnimation",function(a){console.log("famous notSeenAniatmion watch",a),I.show(a?J:K)}),I.show(K),c.$watch("dialog",function(a){z.setContent(a)}),c.$watch("rounds",function(a){a&&(F.length=0,a.forEach(function(a,b){var c=new f({properties:{backgroundColor:"hsl("+360*b/40+", 100%, 50%)",lineHeight:"50px",textAlign:"center"},size:[void 0,50],content:a.log});c.pipe(E),F.push(c)}),console.log(F))}),w.setPerspective(2400),w.add(y).add(z),w.add(G).add(H),w.add(A).add(B),w.add(I),w.add(b()),w.add(b(!0))},500)}}}])}),define(["angular","moment","services/index"],function(a,b){"user strict";return a.module("PvP.filters",[]).filter("calendar",function(){return function(a){return a?b(a).format("MMMM Do YYYY, h:mm:ss a"):""}}).filter("emptyOrInvited",["GameStates","UserSession","Game",function(a,b,c){return function(d){function e(d){var e=new c,f=d.state>=a.invitesSent&&_.keys(d.participants).length<e._limit&&!_.has(d,"invitations");if(b.signedIn()){var g=d.state>=a.invitesSent&&Array.isArray(d.invitations)&&-1!=d.invitations.indexOf(b.currentUser().uid),h=d.state>=a.movesPicked&&d.participants[b.currentUser().uid],i=d.host&&d.host==b.currentUser().uid;return f||g||h||i}return f}var f={};return d.$getIndex().forEach(function(a){e(d[a])&&(f[a]=d[a])}),f}}])}),define(["angular","underscore","es6-shim","es5-shim"],function(a,b){"user strict";return a.module("PvP.services.utils",[]).value("firebaseUrl","https://pvp.firebaseio.com/").factory("pvpSync",["firebaseUrl","$interval","$timeout","$q",function(a,c,d,e){function f(a){return"object"==typeof a&&null!=a?(b.keys(a).forEach(function(b){"undefined"==typeof a[b]||null==a[b]?(console.log("undefined property",b,a[b]),a[b]={}):a[b]=f(a[b])}),a):null==a?{}:a}function g(a){var c=b.omit(a,Object.keys(a).filter(function(a){return a.startsWith("$")}));return f(c)}var h=function(f){function i(a,b){n[a]&&(console.log("trigger callbacks for",a),n[a].forEach(function(a){a(b)}))}function j(a,b){d(function(){-1!=l.$index.indexOf(a.name())&&l.$index.splice(l.$index.indexOf(a.name()),1),null==a.val()?delete l[a.name()]:(l[a.name()]=a.val(),-1!=l.$index.indexOf(b)?l.$index.splice(l.$index.indexOf(b)+1,0,a.name()):l.$index.splice(0,0,a.name()),i(a.name(),a.val()))})}var k,l={},m=e.defer(),n={},o={};return"string"==typeof f?k=new Firebase(a+f):f instanceof Firebase&&(k=f),l=b.extend(l,{$id:k.ref().name(),$ref:k,$child:function(a){return h(k.child(a))},$set:function(a){var b=e.defer();return k.set(g(a),function(){b.resolve(this)}.bind(this)),b.promise},$push:function(a){var b=e.defer(),c=k.push(g(a),function(){h(c).$promise.then(function(a){b.resolve(a)})});return b.promise},$save:function(){var a=e.defer();return k.set(g(this),function(){a.resolve(this)}.bind(this)),a.promise},$index:[],$getIndex:function(){return this.$index},$promise:m.promise,$onChange:function(a,b){""==a||"undefined"==typeof a?(n.$$itself=n.$$itself||[],n.$$itself.push(b)):(n[a]=n[a]||[],n[a].push(b))},$onPoll:function(a,b){o[a]=o[a]||[],o[a].push(b)}}),c(function(){b.keys(o).forEach(function(a){o[a].forEach(function(b){b(l[a])})})},1e3),k.on("child_added",j),k.on("child_changed",j),k.on("child_moved",j),k.on("child_removed",function(a){d(function(){-1!=l.$index.indexOf(a.name())&&l.$index.splice(l.$index.indexOf(a.name()),1),delete l[a.name()]})}),k.on("value",function(a){d(function(){l=b.extend(l,a.val()),m.resolve(l),i("$$itself",l)})}),l};return h}])}),define(["angular"],function(a){"use strict";function b(a,b){localStorage.setItem(a,JSON.stringify(b))}function c(a){return JSON.parse(localStorage.getItem(a))}return a.module("PvP.services.userSession",[]).service("UserSession",["FacebookBase","$timeout","$q","pvpSync",function(a,d,e,f){function g(a){i[a.uid]?(i[a.uid].profile=a,i.$save()):i.$child(a.uid).$child("profile").$set(a)}var h,i=f("/players"),j=function(a){return g(a),h.resolve(a),a},k=function(){h.reject()},l=function(a){return b("user",a),j(a),a},m=function(){c("user")?j(c("user")):a.openLogin().then(l,k)},n=function(){return h=e.defer(),d(m,10),h.promise};return{signIn:n,signedIn:function(){return!!c("user")},currentUser:function(){return c("user")},completeSignIn:l,_resolveOrPrompt:m,_completeAuth:j}}])}),define(["angular"],function(a){"use strict";return a.module("PvP.services.facebook",[]).service("FacebookBase",["$rootScope","$q",function(a,b){return{openLogin:function(){console.log("openLogin");var c=b.defer(),d=new Firebase("https://pvp.firebaseio.com"),e=new FirebaseSimpleLogin(d,function(b,d){console.log("FirebaseSimpleLogin",b,d),b?console.error(b):d&&(console.log("User ID: "+d.id+", Provider: "+d.provider),a.safeApply(function(){c.resolve(d)}))});return e.login("facebook",{rememberMe:!0,preferRedirect:!1,scope:"email,user_likes,basic_info,user_friends"}),c.promise}}}])}),define(["angular"],function(a){"user strict";return a.module("PvP.services.moves",[]).factory("Moves",["firebaseUrl",function(){function a(a){var b=a.split(" ");return 3==b.length&&b.splice(1,1),b.map(function(a,c){return b.length-1==c?a[0]+".":a}).join(" ")}function b(b,c,d,e,f,g){return a(b)+" has taken "+f+" damage from "+e+" :: "+a(c)+" has taken "+g+" damage from "+d+"."}function c(a){var b=Math.floor(100*Math.random());if(60>=b)return a?[2,0]:[0,2];var b=Math.floor(40*Math.random());return 30>=b?[0,0]:a?[0,2]:[2,0]}function d(a,b){if(console.log("damageMatrix",a,b),"Fire"==a){if("Fire"==b)return[2,2];if("Water"==b)return[2,1];if("Lightning"==b)return[1,2];if("Shield"==b)return c()}else if("Water"==a){if("Fire"==b)return[1,2];if("Water"==b)return[1,1];if("Lightning"==b)return[2,1];if("Shield"==b)return c()}else if("Lightning"==a){if("Fire"==b)return[2,1];if("Water"==b)return[1,2];if("Lightning"==b){var d=Math.floor(2*Math.random());if(0==d){if(side=Math.floor(2*Math.random()),0==side)return[3,0];if(1==side)return[0,3]}else if(1==d)return[2,2]}else if("Shield"==b)return c()}else if("Shield"==a){if("Fire"==b)return c(!0);if("Water"==b)return c(!0);if("Lightning"==b)return c(!0);if("Shield"==b)return[0,0]}return[0,0]}var e={fire:{attackCss:"fire-attack",moveCss:"fire-move",name:"Fire",src:"images/buttons/volcanobutton.png"},lightning:{attackCss:"lightning-attack",moveCss:"lightning-move",name:"Lightning",src:"images/buttons/lightningbutton.png"},water:{attackCss:"water-attack",moveCss:"water-move",name:"Water",src:"images/buttons/waterbutton.png"},shield:{attackCss:"shield-attack",moveCss:"shield-move",name:"Shield",src:"images/buttons/magneticfieldbutton.png"}};return{moves:e,damageMatrix:d,textualizeAttack:b}}])}),define(["angular"],function(a){"user strict";return a.module("PvP.services.game",[]).factory("GameStates",function(){return{opened:0,invitesSent:1,started:2,movesPicked:3,finished:4}}).factory("Game",["$q","GameStates",function(a,b){var c=function(a){this._game=a,this._limit=2};return c.prototype.raw=function(){return this._game},c.prototype.opponentOf=function(a){for(var b in this._game.participants)if(this._game.participants.hasOwnProperty(b)&&b!=a)return this._game.participants[b]},c.prototype.player=function(a){return this._game.participants[a]},c.prototype.$redeem=function(c){var d=this;if(this._game.participants=this._game.participants||{},this._game.participants&&this._game.participants[c.uid])return d;if(!this._game.invitations&&this._game.state<b.started);else if(this._game.invitations&&-1==this._game.invitations.indexOf(c.uid)||this._game.state>=b.started)return a.reject("Not invited or Game started");return this._game.participants[c.uid]={selectedMoves:{},health:10,name:c.displayName,uid:c.uid},_.keys(this._game.participants).length==this._limit&&(this._game.state=b.started),this._game.$save().then(function(){return d})},c.prototype.$save=function(){return this._game.$save()},c.prototype.$invite=function(c){if(this._game.invitations=this._game.invitations||[],c.length+this._game.invitations.length>this._limit)return a.reject("Can't invite over the limit ("+this._limit+")");if(0==c.length)return a.reject("Has to invite users");var d=this;return c.forEach(function(a){console.log("inviting",a),-1==d._game.invitations.indexOf(a.uid)&&d._game.invitations.push(a.uid)}),this._game.state=b.invitesSent,this._game.$save().then(function(){return d})},c}])}),define(["angular"],function(a){"user strict";return a.module("PvP.services.games",[]).factory("Games",["$rootScope","$q","pvpSync","Game",function(a,b,c,d){var e=c("/games");return{all:function(){return e},get:function(a){return e.$child(a).$promise.then(function(a){return new d(a)})},construct:function(a){return new d(a)},create:function(a){return a=_.extend(a,{createdAt:moment().toISOString(),rounds:[],state:0}),e.$push(a).then(function(a){return new d(a)})}}}])}),define(["angular"],function(a){"user strict";return a.module("PvP.services.rematch",[]).factory("Rematch",["$location","Game","Games","UserSession","GameStates","$modal","pvpSync",function(a,b,c,d,e,f,g){var h=null;return{listen:function(b){function i(g){var i=d.currentUser();b.raw().state>=e.finished&&g.$getIndex().forEach(function(d){var e=g[d];if(e.from==i.uid&&e.to==b.opponentOf(i.uid).uid&&e.response&&!e.gameId)if("accept"==e.response){var j=b.opponentOf(i.uid);c.create({host:i.uid,title:"A Rematch from "+i.name+" to "+j.name,description:"Best game ever"}).then(function(b){b.$invite([i,j]).then(function(){b.$redeem(i).then(function(){e.gameId=b.raw().$id,g.$save().then(function(){a.path("/game/"+b.raw().$id)})},function(a){alert(a)})},function(a){alert(a)})},function(a){alert(a)})}else"reject"==e.response&&(delete g[d],g.$save());else e.to!=i.uid||e.from!=b.opponentOf(i.uid).uid||_.has(e,"response")?e.to==i.uid&&e.from==b.opponentOf(i.uid).uid&&_.has(e,"response")&&"accept"==e.response&&_.has(e,"gameId")&&(delete g[d],g.$save().then(function(){c.get(e.gameId).then(function(b){b.$redeem(i).then(function(b){a.path("/game/"+b.raw().$id)},function(a){alert(a)})})})):(console.log("Received a rematch request!"),null==h&&(h=f.open({backdrop:"static",keyboard:!1,templateUrl:"views/game/modal/requestRematch.html",controller:function(a,c){a.requester=b.player(e.from),a.accept=function(){console.log("[MODAL] accepting request",e),e.response="accept",g.$save(),h=null,c.close()},a.reject=function(){console.log("[MODAL] rejecting request",e),e.response="reject",g.$save(),h=null,c.close()}}})))})}g("/rematchRequests").$promise.then(function(a){a.$onChange("",i),i(a)})},listenAll:function(){var a=this;c.all().$promise.then(function(c){c.$getIndex().forEach(function(d){a.listen(new b(c[d]))})})}}}])});