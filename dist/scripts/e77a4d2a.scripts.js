"use strict";function saveToStorage(a,b){localStorage.setItem(a,JSON.stringify(b))}function getFromStorage(a){return JSON.parse(localStorage.getItem(a))}angular.module("PvP",["ngCookies","ngResource","ngSanitize","ngRoute","ui.bootstrap","firebase"]).run(["$rootScope","$location","UserSession",function(a,b,c){a.$on("$locationChangeStart",function(a,d){!c.signedIn()&&d.indexOf("login")<0&&(a.preventDefault(),c.signIn().then(function(){b.path(d)},function(){b.path("/login")}))})}]).run(["$rootScope",function(a){a.safeApply=function(a){var b=this.$root.$$phase;"$apply"==b||"$digest"==b?a&&"function"==typeof a&&a():this.$apply(a)}}]).value("firebaseUrl","https://pvp.firebaseio.com/").config(["$routeProvider","$locationProvider",function(a){a.when("/",{templateUrl:"/views/main.html",controller:"MainCtrl"}).when("/login",{templateUrl:"/views/login.html",controller:"LoginCtrl"}).when("/lobby",{templateUrl:"/views/lobby.html",controller:"LobbyCtrl"}).when("/game/:gameId",{templateUrl:"/views/game.html",controller:"GameCtrl",resolve:{gameConfig:function(a,b,c){return a(c.current.params.gameId,b.currentUser().uid)}}}).when("/moves",{templateUrl:"views/moves.html",controller:"MovesCtrl"}).otherwise({redirectTo:"/"})}]),angular.module("PvP").controller("MainCtrl",["$scope","$location","$filter","Games","Moves","$firebase","UserSession",function(a,b,c,d,e){e.all().$then(function(a){console.log(a.$getIndex()),0==a.$getIndex().length&&(e.add({name:"volcano",src:"images/buttons/volcanobutton.png"}),e.add({name:"lightning",src:"images/buttons/lightningbutton.png"}),e.add({name:"water",src:"images/buttons/waterbutton.png"}),e.add({name:"shield",src:"images/buttons/magneticfieldbutton.png"}))}),a.games=d.all(),a.add=function(){d.create({title:"test",description:"Best game ever"}).then(function(a){b.path("/game/"+a)})}}]),angular.module("PvP").controller("LoginCtrl",["$scope","$rootScope","$location","UserSession",function(a,b,c,d){a.loggedIn=!1,a.openLogin=function(){d.signIn().then(a.greetUser)},a.greetUser=function(b){a.user=b,a.loggedIn=!0,a.greeting="Hi "+a.user.displayName,a.userName=a.user.link,a.profilePic="http://graph.facebook.com/"+a.user.link.split("https://www.facebook.com/")[1].trim()+"/picture"},a.loadGame=function(){console.log(c.path("lobby"))}}]),angular.module("PvP").controller("LobbyCtrl",["$scope","$location","Games","UserSession",function(a,b,c){a.games=c.all(),a.openGame=function(a){c.join(a).then(function(){b.path("/game/"+a)})}}]),angular.module("PvP").controller("GameCtrl",["$window","$location","$firebase","$scope","$routeParams","$modal","UserSession","Games","gameConfig","Moves","convertFirebase",function(a,b,c,d,e,f,g,h,i,j){function k(b,c){if(b!=c)switch(b.name){case"waiting_join":d.viewUrl="views/game/preGame.html";break;case"waiting_pick":d.viewUrl="views/game/selectMoves.html";break;case"waiting_move":d.viewUrl="views/game/fightScene.html",d.dialog="What should "+d.currentPlayer().name+" do?";break;case"waiting_other_move":d.viewUrl="views/game/fightScene.html",b.detail==d.currentPlayer().uid&&(d.dialog="Waiting on your opponent");break;case"game_ended":d.viewUrl="views/game/endGame.html",d.winner=b.detail,i.listenOnRematchRequests({hasResponse:function(b){console.log("hasResponse",b),"accept"==b.response?(console.log("opponent has accepted the request"),b.$off(),i.turnOffListeners(),h.create({title:"Rematch",description:"Best game ever"}).then(function(c){b.gameId=c,b.$save().then(function(){a.location.href="/#/game/"+c})})):"reject"==b.response&&(console.log("opponent has rejected the request"),b.$remove())},hasRequest:function(a){console.log("hasRequest",a);var b=d;d.rematchModal||(d.rematchModal=f.open({backdrop:"static",keyboard:!1,templateUrl:"views/game/modal/requestRematch.html",controller:function(c,d){c.requester=a.requester,c.accept=function(){console.log("[MODAL] accepting request",a),i.acceptRematchRequest(a),b.rematchModal=null,d.close()},c.reject=function(){console.log("[MODAL] rejecting request",a),i.rejectRematchRequest(a),b.rematchModal=null,d.close()}}}))}})}}d.moves=j.all(),d.players=i.players,d.game=i.game,d.rounds=i.rounds,d.state=i.state,d.rematchModal=null,i.onChange("state",k),d.$watch("state",k),d.$watch("currentPlayer().notSeenAnimation",function(a){},!0),d.currentPlayer=function(){return i.currentPlayer()},d.opponentPlayer=function(){return i.opponentPlayer()},d.isSelected=function(a){return d.currentPlayer().selectedMoves&&d.currentPlayer().selectedMoves[a]},d.selectMove=function(a){i.commitMove(a)},d.deselectMove=function(a){delete d.currentPlayer().selectedMoves[a.name]},d.doneSelectingMoves=function(){i.doneCommitMoves(),$("button").attr("disabled","disabled")},d.currentRound=function(){var a=0;return d.rounds.$getIndex().forEach(function(b){d.rounds[b]&&d.players&&Object.keys(d.rounds[b]).length==Object.keys(d.players).length&&(a+=1)}),a},d.replayAnimation=function(){},d.skipAnimation=function(){},d.fight=function(a){i.commitAttack(a),d.dialog=d.currentPlayer().name+" selected "+a.name},d.feelingLucky=function(){},d.rematch=function(){i.requestRematch()}}]),angular.module("PvP").controller("MovesCtrl",["$scope","$firebase","firebaseUrl","UserSession","Moves",function(a,b,c,d,e){a.moves=e.all(),a.clear=function(){a.moves.$set({})},a.generateDamageTo=function(a,b){var c={},d=b.$getIndex();return d.forEach(function(a){c[a]=0}),c[a]=0,c},a.addNewDamageToOf=function(a,b,c){a.$child(b).$child("damageTo").$child(c).$set(0)},a.duplicate=function(a,b){var c=b.$getIndex();return c.forEach(function(b){return a==b?!0:void 0}),!1},a.addOne=function(b){if(!a.duplicate(b,a.moves)){var c=a.moves.$child(b),d={name:b,damageTo:a.generateDamageTo(b,a.moves)};c.$set(d).then(function(c){var d=a.moves.$getIndex();return d.forEach(function(c){b!=c&&a.addNewDamageToOf(a.moves,c,b)}),c})}}}]),angular.module("PvP").directive("tooltip",function(){return{restrict:"AE",scope:{tooltip:"@"},link:function(){}}}),angular.module("PvP").factory("convertFirebase",["$q",function(a){return function(b){var c=a.defer();return b.$on("loaded",function(){c.resolve(b)}),b.$then=function(){return c.promise.then.apply(b,arguments)},b}}]),angular.module("PvP").service("UserSession",["Facebook","$timeout","$q",function(a,b,c){var d,e=function(a){return d.resolve(a),a},f=function(){d.reject()},g=function(a){return saveToStorage("user",a),e(a),a},h=function(){getFromStorage("user")?e(getFromStorage("user")):a.openLogin().then(g,f)},i=function(){return d=c.defer(),b(h,10),d.promise};return{signIn:i,signedIn:function(){return!!getFromStorage("user")},currentUser:function(){return getFromStorage("user")},completeSignIn:g,_resolveOrPrompt:h,_completeAuth:e}}]),angular.module("PvP").service("Facebook",["$rootScope","$q",function(a,b){return{openLogin:function(){console.log("openLogin");var c=b.defer(),d=new Firebase("https://pvp.firebaseio.com"),e=new FirebaseSimpleLogin(d,function(b,d){console.log("FirebaseSimpleLogin",b,d),b?console.log(b):d&&(console.log("User ID: "+d.id+", Provider: "+d.provider),a.safeApply(function(){c.resolve(d)}))});return e.login("facebook",{rememberMe:!0,preferRedirect:!0,scope:"email,user_likes"}),c.promise}}}]),angular.module("PvP").factory("Moves",["firebaseUrl","$firebase","convertFirebase",function(a,b,c){function d(a,b,c,d,e,f){return a+" has taken "+e+" from "+d+"; "+b+" has taken "+f+" from "+c+"."}function e(a,b){if(console.log(a,b),"volcano"==a){if("volcano"==b)return[2,2];if("water"==b)return[2,1];if("lightning"==b)return[1,2];if("shield"==b){var c=Math.floor(3*Math.random());if(0==c)return[2,0];if(1==c)return[0,0];if(2==c)return[0,2]}}else if("water"==a){if("volcano"==b)return[1,2];if("water"==b)return[1,1];if("lightning"==b)return[2,1];if("shield"==b){var c=Math.floor(3*Math.random());if(0==c)return[2,0];if(1==c)return[0,0];if(2==c)return[0,2]}}else if("lightning"==a){if("volcano"==b)return[2,1];if("water"==b)return[1,2];if("lightning"==b){var c=Math.floor(2*Math.random());if(0==c){if(side=Math.floor(2*Math.random()),0==side)return[3,0];if(1==side)return[0,3]}else if(1==c)return[2,2]}else if("shield"==b){var c=Math.floor(3*Math.random());if(0==c)return[2,0];if(1==c)return[0,0];if(2==c)return[0,2]}}else if("shield"==a)if("volcano"==b){var c=Math.floor(3*Math.random());if(0==c)return[0,2];if(1==c)return[0,0];if(2==c)return[2,0]}else if("water"==b){var c=Math.floor(3*Math.random());if(0==c)return[0,2];if(1==c)return[0,0];if(2==c)return[2,0]}else if("lightning"==b){var c=Math.floor(3*Math.random());if(0==c)return[0,2];if(1==c)return[0,0];if(2==c)return[2,0]}else if("shield"==b)return[0,0];return[0,0]}var f=c(b(new Firebase(a+"moves")));return{all:function(){return f},add:function(a){return f.$add(a)},get:function(a){return f[a]},damageMatrix:e,textualizeAttack:d}}]),angular.module("PvP").factory("Channel",["$q","$http",function(a,b){return new function(){var c=0;this.connect=function(c){var d=a.defer();return b.get("/connectChannel",{name:c}).success(function(a){var b=goog.appengine.Channel(a),c=b.open();d.resolve(c)}).error(function(){d.reject()}),d.promise},this.setup=function(a,b){this.connect("games").then(function(a){for(var c in b)a[c]=b[c]},function(){3>c?(this.setup(a,b),c+=1):(c=0,alert("Cannot connect to server!"))})}}}]),angular.module("PvP").factory("Game",["$window","$location","$rootScope","$routeParams","$q","Games","Moves","Channel","$firebase","firebaseUrl","convertFirebase","UserSession",function(a,b,c,d,e,f,g,h,i,j,k){function l(a,b){var c=null;return Object.keys(a).forEach(function(a){b!=a&&(c=a)}),c}var m=(f.all(),f.get(),i(new Firebase(j+"rematchRequests")));return function(b,c){return f.get(b).$then(function(d){var e={onChange:function(a,b){d.$child(a).$on("change",function(){b(d[a])})},game:d,players:d.players,opponentPlayer:function(){var a=null;return Object.keys(d.players).forEach(function(b){c!=b&&(a=b)}),d.players[a]},currentPlayer:function(){return d.players[c]},turnOffListeners:function(){m.$off()},state:d.state,rounds:d.$child("rounds"),acceptRematchRequest:function(b){console.log("accept request",b),b&&(b.response="accept",b.$save().then(function(){b.$on("change",function(){b.gameId&&(b.$off(),m.$off(),console.log("requester has created a new game",b.gameId),f.join(b.gameId).then(function(){console.log("joins the game"),b.$remove().then(function(){a.location.href="/#/game/"+b.gameId})}))})}))},rejectRematchRequest:function(a){console.log("reject",a),a&&(console.log("reject rematch request",a),a.response="reject",a.$save())},requestRematch:function(){console.log("requesting rematch");var a=l(d.players,c);m.$add({requester:c,userToRematch:a,fromGameId:b,response:null})},listenOnRematchRequests:function(a){function e(){k(m).$then(function(d){console.log("onChange"),d.$getIndex().forEach(function(e){d[e].requester==c&&d[e].userToRematch==f&&d[e].fromGameId==b&&d[e].response&&!d[e].gameId&&(console.log("hasResponse",d[e]),k(d.$child(e)).$then(function(b){a.hasResponse(b)})),d[e].requester!=f||d[e].userToRematch!=c||d[e].fromGameId!=b||d[e].response||(console.log("hasRequest",d[e]),k(d.$child(e)).$then(function(b){a.hasRequest(b)}))})})}console.log("listenOnRematchRequests");var f=l(d.players,c);e(),m.$on("change",function(){console.log("requestsReq onChange"),e()})},commitMove:function(a){k(d.$child("players").$child(c)).$then(function(b){var c=b.selectedMoves||{};return c[a.name]=a,b.selectedMoves=c,b.$save(),b})},doneCommitMoves:function(){"waiting_pick"==d.state.name&&("both"==d.state.detail?d.state={name:"waiting_pick",detail:c}:d.state.detail!=c&&(d.state={name:"waiting_move",detail:"both"})),d.$save("state")},commitAttack:function(a){k(d.$child("rounds")).$then(function(b){var e=b.$getIndex()[b.$getIndex().length-1],f=b[e];if(f&&f.move&&Object.keys(f.move).length<Object.keys(d.players).length){if(f.move[c]=a,b.$save(e),Object.keys(f.move).length==Object.keys(d.players).length){var h=l(d.players,c),i=g.damageMatrix(f.move[c].name,f.move[h].name);d.players[c].health-=i[0],d.players[h].health-=i[1],Object.keys(d.players).forEach(function(a){d.players[a].notSeenAnimation=e}),d.$save("players");var j=g.textualizeAttack(d.players[c].name,d.players[h].name,f.move[c].name,f.move[h].name,i[0],i[1]);if(console.log(d.players[c].name,d.players[h].name,f.move[c].name,f.move[h].name,i[0],i[1]),f.log=j,b.$save(e),d.players[c].health<=0||d.players[h].health<=0){d.state={name:"game_ended"};var k;d.players[c].health>0?k=h:d.players[h].health>0?k=c:Math.abs(i[0])>Math.abs(i[1])?k=h:Math.abs(i[0])<Math.abs(i[1])&&(k=c),d.state.detail=d.players[k]}else d.state={name:"waiting_move"};d.$save("state")}}else{var m={move:{},log:""};m.move[c]=a,b.$add(m),d.state={name:"waiting_other_move",detail:c},d.$save("state")}})}};return e.watch("game",function(){f.g.$save(b)}),e.watch("players",function(){f.g.$save(b)}),e})}}]),angular.module("PvP").factory("Games",["$rootScope","$q","Channel","firebaseUrl","$firebase","UserSession","convertFirebase",function(a,b,c,d,e,f,g){var h=e(new Firebase(d+"games"));return{g:h,all:function(){return h},get:function(a){return a?g(h.$child(a)):{}},create:function(a){var b=this;return console.log("creating the game"),f.signIn().then(function(c){return a=_.extend(a,{rounds:[],state:{name:"waiting_join",detail:c.uid}}),console.log("creating game with options",a),h.$add(a).then(function(a){return b.join(a.name())})})},join:function(a){return f.signIn().then(function(b){return g(h.$child(a)).$then(function(c){return c.players=c.players||{},c.players[b.uid]={uid:b.uid,selectedMoves:{},health:10,name:b.displayName},c.state=c.state||{},c.state&&"waiting_join"==c.state.name&&c.state.detail&&c.state.detail!=b.uid&&(c.state={name:"waiting_pick",detail:"both"}),c.$save().then(function(){return a})})})}}}]);