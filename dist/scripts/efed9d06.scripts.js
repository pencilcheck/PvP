define(["angular","angular-sanitize","angular-route","angular-resource","angular-facebook","angular-cookies","angular-bootstrap","firebase","firebase-simple-login","controllers/index","services/index","directives","filters"],function(a){"use strict";return a.module("PvP",["ngCookies","ngResource","ngSanitize","ngRoute","ui.bootstrap","facebook","wu.masonry","PvP.controllers","PvP.services","PvP.directives","PvP.filters"]).config(["FacebookProvider",function(a){a.init("1440880659476523")}]).run(["$rootScope","$location","UserSession",function(a){a.$on("$locationChangeStart",function(){})}]).run(["$rootScope",function(a){a.safeApply=function(a){var b=this.$root.$$phase;"$apply"==b||"$digest"==b?a&&"function"==typeof a&&a():this.$apply(a)}}]).config(["$routeProvider","$locationProvider",function(a){a.when("/",{templateUrl:"/views/main.html",controller:"MainCtrl"}).when("/login",{templateUrl:"/views/login.html",controller:"LoginCtrl"}).when("/lobby",{templateUrl:"/views/lobby.html",controller:"LobbyCtrl"}).when("/game/:gameId",{templateUrl:"/views/game.html",controller:"GameCtrl",resolve:{currentUser:function(a){return a.signIn().then(function(a){return a})},game:function(a,b,c){return b.get(a.current.params.gameId).then(function(a){return c.signIn().then(function(){return a.$redeem(c.currentUser())})})},rematchRequests:function(a){return a("/rematchRequests").$promise}}}).otherwise({redirectTo:"/"})}])}),define(["angular","services/index"],function(a){"use strict";return a.module("PvP.controllers.main",[]).controller("MainCtrl",["$scope","$location","$filter","Games","Rematch","UserSession",function(a,b,c,d,e,f){a.games=d.all(),e.listenAll(),a.add=function(){f.signIn().then(function(a){d.create({host:a.uid,title:"test",description:"Best game ever"}).then(function(a){b.path("/game/"+a.raw().$id)},function(a){alert(a)})})},a.openGame=function(a){b.path("/game/"+a)}}])}),define(["angular","services/index"],function(a){"use strict";return a.module("PvP.controllers.login",[]).controller("LoginCtrl",["$scope","$rootScope","$location","UserSession",function(a,b,c,d){a.loggedIn=!1,a.openLogin=function(){d.signIn().then(a.greetUser)},a.greetUser=function(b){a.user=b,a.loggedIn=!0,a.greeting="Hi "+a.user.displayName,a.userName=a.user.link,a.profilePic="http://graph.facebook.com/"+a.user.link.split("https://www.facebook.com/")[1].trim()+"/picture"},a.loadGame=function(){console.log(c.path("lobby"))}}])}),define(["angular","services/index"],function(a){"use strict";return a.module("PvP.controllers.lobby",[]).controller("LobbyCtrl",["$scope","$location","Games","UserSession",function(a,b,c){a.games=c.all(),a.openGame=function(a){c.join(a).then(function(){b.path("/game/"+a)},function(a){alert(a)})}}])}),define(["angular","require","jquery","masonry","angular-masonry","services/index"],function(a,b,c,d){"use strict";return b(["jquery-bridget/jquery.bridget"],function(){c.bridget("masonry",d)}),a.module("PvP.controllers.game",["PvP.services","PvP.directives"]).controller("GameCtrl",["$scope","$rootScope","$timeout","$location","$routeParams","$modal","currentUser","Games","GameStates","game","Moves","Rematch","rematchRequests","Facebook","pvpSync",function(b,d,e,f,g,h,i,j,k,l,m,n,o,p,q){function r(a){b.safeApply(function(){switch(a){case k.opened:console.log("Just opened the game, need to invite people: to invitePlayers"),b.viewUrl="views/game/invitePlayers.html",s();break;case k.invitesSent:console.log("Just sent all invitations, waiting to others to redeem: to preGame"),b.viewUrl="views/game/preGame.html";break;case k.started:console.log("All players have redeemed, start picking moves: to selectMoves"),b.viewUrl="views/game/selectMoves.html",u();break;case k.movesPicked:console.log("All players have selected moves, fight: to fightScene"),b.viewUrl="views/game/fightSceneFamous.html",A();break;case k.finished:b.viewUrl||(console.log("Someone died: to endGame"),b.viewUrl="views/game/endGame.html",B())}})}function s(){p.api("/me/friends","get",{fields:"id, name, picture",access_token:i.accessToken},function(a){b.friends=a.data})}function t(a){function b(){var b=!0;return _.keys(a).forEach(function(c){a[c].movesCommitted||(b=!1)}),b}l.raw().state==k.started&&b()&&(l.raw().state=k.movesPicked,l.$save())}function u(){console.log("setupSelectMoves"),l.player(i.uid).selectedMoves=l.player(i.uid).selectedMoves||{},l.player(i.uid).movesCommitted=l.player(i.uid).movesCommitted||!1,b.moves=m.moves,b.selectedMoves=a.copy(l.player(i.uid).selectedMoves),b.movesCommitted=a.copy(l.player(i.uid).movesCommitted),b.selectedMovesCount=function(){return _.keys(b.selectedMoves).length},b.isSelected=function(a){return b.selectedMoves&&_.has(b.selectedMoves,a)},b.selectMove=function(c){b.selectedMovesCount()<3&&(b.selectedMoves[c]=a.copy(b.moves[c]))},b.unselectMove=function(a){delete b.selectedMoves[a]},b.commitSelectedMoves=function(){3==b.selectedMovesCount()&&(b.movesCommitted=l.player(i.uid).movesCommitted=!0,l.player(i.uid).selectedMoves=b.selectedMoves,l.$save())}}function v(a,b,c,d){(0>=a||0>=b)&&(a>0?l.raw().winner=i.uid:b>0?l.raw().winner=l.opponentOf(i.uid).uid:Math.abs(c)>Math.abs(d)?l.raw().winner=l.opponentOf(i.uid).uid:Math.abs(c)<Math.abs(d)&&(l.raw().winner=i.uid))}function w(d){function e(){return _.keys(d).length==_.keys(l.raw().participants).length}if(console.log("currentRound onChange"),l.raw().state==k.movesPicked){if(e()){console.log("all committed"),b.notSeenAnimation=!0;var f=l.opponentOf(i.uid).uid;b.opponentAttack=m.moves[l.raw().currentRound[f].moveKey],b.opponentSmackTalk=l.raw().currentRound[f].smackTalk;var g=m.damageMatrix(m.moves[d[i.uid].moveKey].name,m.moves[d[l.opponentOf(i.uid).uid].moveKey].name);d[i.uid].doneDamage=g[1],d[l.opponentOf(i.uid).uid].doneDamage=g[0],g[0]>0&&(l.player(i.uid).health-=g[0]),g[1]>0&&(l.opponentOf(i.uid).health-=g[1]),console.log("move damage results",g),d.log=m.textualizeAttack(l.player(i.uid).name,l.opponentOf(i.uid).name,m.moves[d[i.uid].moveKey].name,m.moves[d[l.opponentOf(i.uid).uid].moveKey].name,g[0],g[1]),v(l.player(i.uid).health,l.opponentOf(i.uid).health,g[0],g[1]),l.raw().rounds.push(a.copy(d)),l.raw().currentRound={},l.$save(),c("#heart").removeClass("hinge animated"),c("#heart2").removeClass("hinge animated"),c("#heart").html(g[0]>0?"-"+g[0]+" &hearts;":""),c("#heart2").html(g[1]>0?"-"+g[1]+" &hearts;":""),c("#heart").addClass("hinge animated"),c("#heart2").addClass("hinge animated")}z()}}function x(c){e(function(){b.rounds=a.copy(c),console.log("rounds",b.rounds)})}function y(){l.raw().state>=k.movesPicked&&(b.health=l.player(i.uid).health,b.opponentHealth=l.opponentOf(i.uid).health,console.log("update health",b.health,b.opponentHealth))}function z(){b.dialog=b.attackCommitted()&&!b.notSeenAnimation?"Waiting on your opponent...":"What should "+l.player(i.uid).name+" do?"}function A(){console.count("setupFightScene"),l.raw().rounds=l.raw().rounds||[],l.raw().currentRound=l.raw().currentRound||{},b.notSeenAnimation=!1,b.form={},b.opponentSmackTalk="",b.attack=b.opponentAttack=null,l.raw().currentRound[i.uid]&&(b.form.smackTalk=l.raw().currentRound[i.uid].smackTalk,b.attack=m.moves[l.raw().currentRound[i.uid].moveKey]),b.attackCommitted=function(){return l.raw().currentRound&&_.has(l.raw().currentRound,i.uid)||b.notSeenAnimation},b.replayAnimation=function(){},b.skipAnimation=function(){b.notSeenAnimation=!1},z(),b.selectedMoves=l.player(i.uid).selectedMoves,b.health=l.player(i.uid).health,b.opponentHealth=l.opponentOf(i.uid).health,b.fight=function(c,d){l.raw().currentRound=l.raw().currentRound||{},l.raw().currentRound[i.uid]={moveKey:c,smackTalk:d},l.$save(),b.form.smackTalk=a.copy(d),b.attack=a.copy(m.moves[c]),console.log("attacking with attack and smackTalk",b.attack,b.form.smackTalk)},b.dice=function(){}}function B(){n.listen(l),b.winner=l.player(l.raw().winner),b.rematch=function(){var a={from:i.uid,to:l.opponentOf(i.uid).uid,fromGameId:g.gameId},b=!1;o.$getIndex().forEach(function(c){_.isEqual(o[c],a)&&(b=!0)}),b||o.$push(a)},b.toLobby=function(){f.path("/")}}d.$on("$routeChangeError",function(){f.path("/")}),l.raw().$onChange("state",r),r(l.raw().state),l.raw().$onChange("participants",t),t(l.raw().participants),b.inviteNoop=function(){l.raw().state=k.invitesSent,l.$save()},b.$watch("notSeenAnimation",function(a,c){if(!a&&c&&(console.log("Reset smackTalk, and opponent"),b.form={},b.opponentSmackTalk="",b.attack=b.opponentAttack=null,l.raw().winner)){l.raw().state=k.finished,l.$save(),console.log("Someone died: to endGame"),b.viewUrl="views/game/endGame.html",B();var d=q("/players/"+l.raw().winner);d.$promise.then(function(){d.wins=d.wins||[],d.wins.indexOf(l.raw().$id)&&(d.wins.push(l.raw().$id),d.$save())});var e=q("/players/"+l.opponentOf(l.raw().winner).uid);e.$promise.then(function(){e.loses=e.loses||[],e.loses.indexOf(l.raw().$id)&&(e.loses.push(l.raw().$id),e.$save())})}}),l.raw().$onChange("currentRound",w),w(l.raw().currentRound),l.raw().$onChange("rounds",x),x(l.raw().rounds),l.raw().$onChange("participants",y),y(l.raw().participants)}])}),define(function(a){"user strict";var b=a("angular");return b.module("PvP.directives",[]).directive("arena",["$timeout",function(b){return{restrict:"AE",link:function(c,d){b(function(){function b(){var a=[];R.sequenceFrom(a);var b=[{name:"Fire",cssClasses:["fire-attack"]},{name:"Lightning",cssClasses:["lightning-attack"]},{name:"Water",cssClasses:["water-attack"]},{name:"Shield",cssClasses:["shield-attack"]}];b.forEach(function(b){var c=new k({size:[60,60],classes:b.cssClasses}),d=new t({position:[0,0,0]}),e=new u({anchor:[0,0,0],period:400,dampingRatio:.2});D.attach(e,d),D.addBody(d),c.on("click",function(){d.applyForce(new q(0,0,-0.25))});var f=new v;f.add(d).add(c),a.push(f)})}function e(){U.render(),T+=.01}function f(){var a=[];U.sequenceFrom(a),_.range(c.health).forEach(function(){var b=new l({size:[50,50],content:"images/misc/life.png"});a.push(b)})}function g(){X.setTransform(w.rotateZ(V)),W?V+=1*Math.PI/180:V-=1*Math.PI/180,V>=Math.PI/180?W=0:V<=-Math.PI/180&&(W=1)}function h(){X.setTransform(w.rotateZ(0))}function i(){var a=[];gb.sequenceFrom(a),_.range(c.opponentHealth).forEach(function(){var b=new l({size:[50,50],content:"images/misc/life.png"});a.push(b)})}var j=a("famous/core/Engine"),k=a("famous/core/Surface"),l=a("famous/surfaces/ImageSurface"),m=a("famous/modifiers/StateModifier"),n=(a("famous/modifiers/Draggable"),a("famous/transitions/Easing"),a("famous/core/Modifier")),o=a("famous/surfaces/InputSurface"),p=a("famous/views/SequentialLayout"),q=a("famous/math/Vector"),r=a("famous/utilities/Utility"),s=a("famous/physics/PhysicsEngine"),t=a("famous/physics/bodies/Particle"),u=a("famous/physics/forces/Spring"),v=a("famous/core/RenderNode"),w=a("famous/core/Transform"),x=(a("famous/transitions/Transitionable"),a("famous/utilities/Timer")),y=a("famous/views/GridLayout"),p=a("famous/views/SequentialLayout"),z=a("famous/views/Scrollview"),A=a("famous/surfaces/ContainerSurface"),B=a("famous/views/RenderController"),C=j.createContext(d[0]),D=new s,E=new m({origin:[.5,0]}),F=new k({size:[void 0,200],classes:["red-bg"],content:"What should we do?",properties:{lineHeight:"200px",textAlign:"center",fontSize:"xx-large"}}),G=new m({transform:w.inFront,origin:[.5,1]}),H=new B,I=new A({size:[void 0,100],properties:{overflow:"hidden"},classes:["console-log-famous"]}),J=(new k({size:[void 0,100]}),new k({size:[void 0,100],properties:{lineHeight:"100px",textAlign:"center"},content:"CLICK ME"}));H.show(J);var K=new z,L=[];K.sequenceFrom(L),I.add(K),J.on("click",function(){H.show(I)}),I.on("click",function(){H.show(J)});var M=new m({origin:[.5,.5]}),N=new k({size:[500,500],classes:["explosion"]}),O=new l({size:[300,300],content:"images/planets/player1.png"}),P=new k({classes:["bubble-famous"],properties:{lineHeight:"50px",textAlign:"center",fontSize:"22px",color:"#ACD6E5"},content:"test test test"}),Q=new o({size:[void 0,40],name:"smackTalkSurface",placeholder:"Smack Talk",value:"",type:"text"}),R=new p({direction:r.Direction.X,size:[200,60]});b();var S=new m({}),T=0,U=new p;U.setOutputFunction(function(a,b,d){var e=w.translate(175,175,0);return e=w.multiply(w.aboutOrigin([200,0,200],w.rotateY(360*d/c.health*Math.PI/180+T)),e),e=w.multiply(w.rotateX(20*Math.PI/180),e),e=w.multiply(w.rotateZ(20*Math.PI/180),e),{transform:e,target:a.render()}}),f();var V=0,W=1,X=new m({origin:[.5,.5]}),Y=new m({size:[350,150],transform:w.translate(-50,-300,0)}),Z=new v;Z.add(new m({origin:[.5,.5]})).add(P),Z.add(new m({origin:[.5,.1]})).add(Q),Z.add(new m({origin:[.5,.8]})).add(R);var $=new m({size:[300,300]}),ab=new v;ab.add(X).add(O),ab.add(S).add(U);var bb=C.add(new m({origin:[.2,.8]}));bb.add($).add(ab),bb.add(Y).add(Z);var cb=new l({size:[300,300],content:"images/planets/player2.png"}),db=new k({classes:["bubble2-famous"],properties:{lineHeight:"225px",textAlign:"center",fontSize:"22px",color:"#ACD6E5"},content:"test test test"}),eb=new k({size:[60,60],classes:["fire-attack"]}),fb=new m({size:[250,100],origin:[.3,.8]}),gb=new y({dimensions:[5,2]});i();var hb=new m({size:[350,150],transform:w.translate(50,300,0)}),ib=new v;ib.add(new m({origin:[.5,.5]})).add(db),ib.add(new m({origin:[.5,.2]})).add(eb);var jb=new m({size:[300,300]}),kb=new v;kb.add(cb),kb.add(fb).add(gb);var lb=C.add(new n({origin:[.8,.2]}));lb.add(jb).add(kb),lb.add(hb).add(ib),O.on("mouseover",function(){j.on("prerender",e),j.on("prerender",g)}),O.on("mouseout",function(){x.clear(g),x.clear(e),h()}),c.$watch("dialog",function(a){F.setContent(a)}),c.$watch("notSeenAnimation",function(a){}),c.$watch("attackCommitted()",function(){}),c.$watch("rounds",function(a){L.length=0,a.forEach(function(a,b){var c=new k({properties:{backgroundColor:"hsl("+360*b/40+", 100%, 50%)",lineHeight:"200px",textAlign:"center"},size:[200,50],content:a.log});c.pipe(K),L.push(c)}),console.log(L)}),C.setPerspective(2400),C.add(E).add(F),C.add(M).add(N),C.add(G).add(H)},500)}}}])}),define(["angular","moment","services/index"],function(a,b){"user strict";return a.module("PvP.filters",[]).filter("calendar",function(){return function(a){return a?b(a).format("MMMM Do YYYY, h:mm:ss a"):""}}).filter("emptyOrInvited",["GameStates","UserSession","Game",function(a,b,c){return function(d){function e(d){var e=new c,f=d.state>=a.invitesSent&&_.keys(d.participants).length<e._limit&&!_.has(d,"invitations");if(b.signedIn()){var g=d.state>=a.invitesSent&&Array.isArray(d.invitations)&&-1!=d.invitations.indexOf(b.currentUser().uid),h=d.state>=a.movesPicked&&d.participants[b.currentUser().uid],i=d.host&&d.host==b.currentUser().uid;return f||g||h||i}return f}var f={};return d.$getIndex().forEach(function(a){e(d[a])&&(f[a]=d[a])}),f}}])}),define(["angular","underscore","es6-shim","es5-shim"],function(a,b){"user strict";return a.module("PvP.services.utils",[]).value("firebaseUrl","https://pvp.firebaseio.com/").factory("pvpSync",["firebaseUrl","$interval","$timeout","$q",function(a,c,d,e){function f(a){return"object"==typeof a&&null!=a?(b.keys(a).forEach(function(b){"undefined"==typeof a[b]||null==a[b]?(console.log("undefined property",b,a[b]),a[b]={}):a[b]=f(a[b])}),a):null==a?{}:a}function g(a){var c=b.omit(a,Object.keys(a).filter(function(a){return a.startsWith("$")}));return f(c)}var h=function(f){function i(a,b){n[a]&&(console.log("trigger callbacks for",a),n[a].forEach(function(a){a(b)}))}function j(a,b){d(function(){-1!=l.$index.indexOf(a.name())&&l.$index.splice(l.$index.indexOf(a.name()),1),null==a.val()?delete l[a.name()]:(l[a.name()]=a.val(),-1!=l.$index.indexOf(b)?l.$index.splice(l.$index.indexOf(b)+1,0,a.name()):l.$index.splice(0,0,a.name()),i(a.name(),a.val()))})}var k,l={},m=e.defer(),n={},o={};return"string"==typeof f?k=new Firebase(a+f):f instanceof Firebase&&(k=f),l=b.extend(l,{$id:k.ref().name(),$ref:k,$child:function(a){return h(k.child(a))},$set:function(a){var b=e.defer();return k.set(g(a),function(){b.resolve(this)}.bind(this)),b.promise},$push:function(a){var b=e.defer(),c=k.push(g(a),function(){h(c).$promise.then(function(a){b.resolve(a)})});return b.promise},$save:function(){var a=e.defer();return k.set(g(this),function(){a.resolve(this)}.bind(this)),a.promise},$index:[],$getIndex:function(){return this.$index},$promise:m.promise,$onChange:function(a,b){""==a||"undefined"==typeof a?(n.$$itself=n.$$itself||[],n.$$itself.push(b)):(n[a]=n[a]||[],n[a].push(b))},$onPoll:function(a,b){o[a]=o[a]||[],o[a].push(b)}}),c(function(){b.keys(o).forEach(function(a){o[a].forEach(function(b){b(l[a])})})},1e3),k.on("child_added",j),k.on("child_changed",j),k.on("child_moved",j),k.on("child_removed",function(a){d(function(){-1!=l.$index.indexOf(a.name())&&l.$index.splice(l.$index.indexOf(a.name()),1),delete l[a.name()]})}),k.on("value",function(a){d(function(){l=b.extend(l,a.val()),m.resolve(l),i("$$itself",l)})}),l};return h}])}),define(["angular"],function(a){"use strict";function b(a,b){localStorage.setItem(a,JSON.stringify(b))}function c(a){return JSON.parse(localStorage.getItem(a))}return a.module("PvP.services.userSession",[]).service("UserSession",["FacebookBase","$timeout","$q","pvpSync",function(a,d,e,f){function g(a){i[a.uid]?(i[a.uid].profile=a,i.$save()):i.$child(a.uid).$child("profile").$set(a)}var h,i=f("/players"),j=function(a){return g(a),h.resolve(a),a},k=function(){h.reject()},l=function(a){return b("user",a),j(a),a},m=function(){c("user")?j(c("user")):a.openLogin().then(l,k)},n=function(){return h=e.defer(),d(m,10),h.promise};return{signIn:n,signedIn:function(){return!!c("user")},currentUser:function(){return c("user")},completeSignIn:l,_resolveOrPrompt:m,_completeAuth:j}}])}),define(["angular"],function(a){"use strict";return a.module("PvP.services.facebook",[]).service("FacebookBase",["$rootScope","$q","Facebook",function(a,b){return{openLogin:function(){console.log("openLogin");var c=b.defer(),d=new Firebase("https://pvp.firebaseio.com"),e=new FirebaseSimpleLogin(d,function(b,d){console.log("FirebaseSimpleLogin",b,d),b?console.error(b):d&&(console.log("User ID: "+d.id+", Provider: "+d.provider),a.safeApply(function(){c.resolve(d)}))});return e.login("facebook",{rememberMe:!0,preferRedirect:!0,scope:"email,user_likes,basic_info,user_friends"}),c.promise}}}])}),define(["angular"],function(a){"user strict";return a.module("PvP.services.moves",[]).factory("Moves",["firebaseUrl",function(){function a(a){var b=a.split(" ");return 3==b.length&&b.splice(1,1),b.map(function(a,c){return b.length-1==c?a[0]+".":a}).join(" ")}function b(b,c,d,e,f,g){return a(b)+" has taken "+f+" from "+e+" :: "+a(c)+" has taken "+g+" from "+d+"."}function c(a){var b=Math.floor(100*Math.random());if(60>=b)return a?[2,0]:[0,2];var b=Math.floor(40*Math.random());return 30>=b?[0,0]:a?[0,2]:[2,0]}function d(a,b){if(console.log("damageMatrix",a,b),"Fire"==a){if("Fire"==b)return[2,2];if("Water"==b)return[2,1];if("Lightning"==b)return[1,2];if("Shield"==b)return c()}else if("Water"==a){if("Fire"==b)return[1,2];if("Water"==b)return[1,1];if("Lightning"==b)return[2,1];if("Shield"==b)return c()}else if("Lightning"==a){if("Fire"==b)return[2,1];if("Water"==b)return[1,2];if("Lightning"==b){var d=Math.floor(2*Math.random());if(0==d){if(side=Math.floor(2*Math.random()),0==side)return[3,0];if(1==side)return[0,3]}else if(1==d)return[2,2]}else if("Shield"==b)return c()}else if("Shield"==a){if("Fire"==b)return c(!0);if("Water"==b)return c(!0);if("Lightning"==b)return c(!0);if("Shield"==b)return[0,0]}return[0,0]}var e={fire:{attackCss:"fire-attack",moveCss:"fire-move",name:"Fire",src:"images/buttons/volcanobutton.png"},lightning:{attackCss:"lightning-attack",moveCss:"lightning-move",name:"Lightning",src:"images/buttons/lightningbutton.png"},water:{attackCss:"water-attack",moveCss:"water-move",name:"Water",src:"images/buttons/waterbutton.png"},shield:{attackCss:"shield-attack",moveCss:"shield-move",name:"Shield",src:"images/buttons/magneticfieldbutton.png"}};return{moves:e,damageMatrix:d,textualizeAttack:b}}])}),define(["angular"],function(a){"user strict";return a.module("PvP.services.game",[]).factory("GameStates",function(){return{opened:0,invitesSent:1,started:2,movesPicked:3,finished:4}}).factory("Game",["$q","GameStates",function(a,b){var c=function(a){this._game=a,this._limit=2};return c.prototype.raw=function(){return this._game},c.prototype.opponentOf=function(a){for(var b in this._game.participants)if(this._game.participants.hasOwnProperty(b)&&b!=a)return this._game.participants[b]},c.prototype.player=function(a){return this._game.participants[a]},c.prototype.$redeem=function(c){var d=this;if(this._game.participants=this._game.participants||{},this._game.participants&&this._game.participants[c.uid])return d;if(!this._game.invitations&&this._game.state<b.started);else if(this._game.invitations&&-1==this._game.invitations.indexOf(c.uid)||this._game.state>=b.started)return a.reject("Not invited or Game started");return this._game.participants[c.uid]={selectedMoves:{},health:10,name:c.displayName,uid:c.uid},_.keys(this._game.participants).length==this._limit&&(this._game.state=b.started),this._game.$save().then(function(){return d})},c.prototype.$save=function(){return this._game.$save()},c.prototype.$invite=function(c){if(this._game.invitations=this._game.invitations||[],c.length+this._game.invitations.length>this._limit)return a.reject("Can't invite over the limit ("+this._limit+")");if(0==c.length)return a.reject("Has to invite users");var d=this;return c.forEach(function(a){console.log("inviting",a),-1==d._game.invitations.indexOf(a.uid)&&d._game.invitations.push(a.uid)}),this._game.state=b.invitesSent,this._game.$save().then(function(){return d})},c}])}),define(["angular"],function(a){"user strict";return a.module("PvP.services.games",[]).factory("Games",["$rootScope","$q","pvpSync","Game",function(a,b,c,d){var e=c("/games");return{all:function(){return e},get:function(a){return e.$child(a).$promise.then(function(a){return new d(a)})},construct:function(a){return new d(a)},create:function(a){return a=_.extend(a,{createdAt:moment().toISOString(),rounds:[],state:0}),e.$push(a).then(function(a){return new d(a)})}}}])}),define(["angular"],function(a){"user strict";return a.module("PvP.services.rematch",[]).factory("Rematch",["$location","Game","Games","UserSession","GameStates","$modal","pvpSync",function(a,b,c,d,e,f,g){var h=null;return{listen:function(b){function i(g){var i=d.currentUser();b.raw().state>=e.finished&&g.$getIndex().forEach(function(d){var e=g[d];if(e.from==i.uid&&e.to==b.opponentOf(i.uid).uid&&e.response&&!e.gameId)if("accept"==e.response){var j=b.opponentOf(i.uid);c.create({host:i.uid,title:"A Rematch from "+i.name+" to "+j.name,description:"Best game ever"}).then(function(b){b.$invite([i,j]).then(function(){b.$redeem(i).then(function(){e.gameId=b.raw().$id,g.$save().then(function(){a.path("/game/"+b.raw().$id)})},function(a){alert(a)})},function(a){alert(a)})},function(a){alert(a)})}else"reject"==e.response&&(delete g[d],g.$save());else e.to!=i.uid||e.from!=b.opponentOf(i.uid).uid||_.has(e,"response")?e.to==i.uid&&e.from==b.opponentOf(i.uid).uid&&_.has(e,"response")&&"accept"==e.response&&_.has(e,"gameId")&&(delete g[d],g.$save().then(function(){c.get(e.gameId).then(function(b){b.$redeem(i).then(function(b){a.path("/game/"+b.raw().$id)},function(a){alert(a)})})})):(console.log("Received a rematch request!"),null==h&&(h=f.open({backdrop:"static",keyboard:!1,templateUrl:"views/game/modal/requestRematch.html",controller:function(a,c){a.requester=b.player(e.from),a.accept=function(){console.log("[MODAL] accepting request",e),e.response="accept",g.$save(),h=null,c.close()},a.reject=function(){console.log("[MODAL] rejecting request",e),e.response="reject",g.$save(),h=null,c.close()}}})))})}g("/rematchRequests").$promise.then(function(a){a.$onChange("",i),i(a)})},listenAll:function(){var a=this;c.all().$promise.then(function(c){c.$getIndex().forEach(function(d){a.listen(new b(c[d]))})})}}}])});